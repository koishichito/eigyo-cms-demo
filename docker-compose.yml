# =============================================================
# Blue-Green Deployment with Reverse Proxy
# =============================================================
#
# Architecture:
#   [Client] -> [proxy :80] -> [app-blue | app-green]
#
# Usage:
#   ./scripts/deploy.sh     # Deploy new version
#   ./scripts/rollback.sh   # Roll back to previous version
#   ./scripts/status.sh     # Show current deployment status
# =============================================================

services:
  # -----------------------------------------------------------
  # Reverse proxy - routes traffic to the active environment
  # -----------------------------------------------------------
  proxy:
    image: nginx:1.27-alpine
    container_name: jnavi-proxy
    ports:
      - "${PROXY_PORT:-80}:80"
    volumes:
      - ./nginx/active.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      app-blue:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - app-network

  # -----------------------------------------------------------
  # Blue environment
  # -----------------------------------------------------------
  app-blue:
    image: ${IMAGE_NAME:-jnavi-app}:${BLUE_TAG:-latest}
    container_name: jnavi-blue
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    networks:
      - app-network

  # -----------------------------------------------------------
  # Green environment
  # -----------------------------------------------------------
  app-green:
    image: ${IMAGE_NAME:-jnavi-app}:${GREEN_TAG:-latest}
    container_name: jnavi-green
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
